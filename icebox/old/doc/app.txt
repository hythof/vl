#!/usr/bin/vl

-- App
# global
Item {
  kind ["その他" "雑費" "食費" "被服" "交際費" "通信費" "教養"].enum
  cost 0
  at   DateTime
}
kakiebo [Item]
label {
  title    "項目名"
  currency "円"
  edit     "編集"
}

# public
run cgi(.request_method == "POST") = run_post cgi
run cgi = run_get cgi
run_get cgi = cgi.out h.index(kakeibo) {
  kw = html "hello kakeibo"
  h  = kw "kakeibo kakei tool app"
}
run_post cgi = cgi.location "./" {
  kakiebo.add cgi.param[kind cost]
}

# private
html title kw = {
  layout body = """
html
  head
    title $title
  body
    h1 $kw " | " $title
    $body
    &copy; 2011
""".conv

  index list = layout """
form action=./ method=post
  select name=kind
    option value=$k $k # Kakeibo.kind.each -> k
  input type=text name=price

table
  tr
    th $label.title
    th $label.price
    th $label.edit
  tr # list.each -> k
    td $k.kind
    td $k.price
""".conv

  # effect in this function only
  String.conv s = s # todo: convert like haml text to html5 format
  Number.ToString n = n.to_string.comma ++ lang_currency
}

-- main
env   :: Env
conf  = env.file.yaml "config.yaml"
cgi   = CGI env
mysql = MySQL conf.host conf.user conf.password conf.port
app   = App {
#  kakeibo = mysql.fetch [Kakeibo] "SELECT * FROM kakeibo"
  kakeibo = mysql {
    .fetch "SELECT * FROM kakeibo ORDER BY date DESC"
    .map -> row; Kakeibo row.kind row.cost row.at
  }
}
hook_logger env = () {
  log = Logger env
  hook = env.app.hook.before
  hook.run_get = logger.debug "run_cgi: callme"
}
run_cgi env = App.run $ CGI.run env
main env = run_cgi . hook_logger
main env(.kick == "console") app = run_cgi # no logging

-- test
case1 method arg = app."run_$method" arg {
  app = App {
    kakeibo = [Kakeibo "foo" "bar" 200]
  }
}
get  c = c "get"
post c = c "post"
post1 c = post c {request_method = "POST" param=["kind"=> 2 "cost" => 105]}

test 200 post1.code 

-- Library
package MySQL

Depend {
  host user password port :: String
  sock :: IO
}

